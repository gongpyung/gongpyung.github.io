name: notify pages deploy (telegram)

on:
  workflow_run:
    workflows: ["pages build and deployment"]
    types: [completed]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          RUN_URL: ${{ github.event.workflow_run.html_url }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          COMMIT: ${{ github.event.workflow_run.head_sha }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "TELEGRAM_BOT_TOKEN / TELEGRAM_CHAT_ID secret missing."
            exit 1
          fi

          SHORT_SHA=$(echo "$COMMIT" | cut -c1-7)

          if [ "$CONCLUSION" = "success" ]; then
            MSG="✅ GitHub Pages 배포 완료\n브랜치: $BRANCH\n커밋: $SHORT_SHA\n상세: $RUN_URL"
          else
            MSG="❌ GitHub Pages 배포 실패 ($CONCLUSION)\n브랜치: $BRANCH\n커밋: $SHORT_SHA\n상세: $RUN_URL"
          fi

          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            --data-urlencode text="$MSG"