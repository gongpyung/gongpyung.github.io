name: notify pages deploy (telegram)

on:
  workflow_run:
    # GitHub Pages built-in deploy workflow name can appear as pages-build-deployment
    workflows: ["pages-build-deployment", "pages build and deployment"]
    types: [completed]
  workflow_dispatch:
    inputs:
      test_message:
        description: "Send test message"
        required: false
        default: "manual test"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Send Telegram notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          EVENT_NAME: ${{ github.event_name }}
          CONCLUSION: ${{ github.event.workflow_run.conclusion }}
          RUN_URL: ${{ github.event.workflow_run.html_url }}
          BRANCH: ${{ github.event.workflow_run.head_branch }}
          COMMIT: ${{ github.event.workflow_run.head_sha }}
          TEST_MESSAGE: ${{ github.event.inputs.test_message }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "TELEGRAM_BOT_TOKEN / TELEGRAM_CHAT_ID secret missing."
            exit 1
          fi

          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            MSG="ğŸ§ª Telegram ì•Œë¦¼ í…ŒìŠ¤íŠ¸ ì„±ê³µ\në©”ì‹œì§€: ${TEST_MESSAGE:-manual test}"
          else
            SHORT_SHA=$(echo "$COMMIT" | cut -c1-7)
            if [ "$CONCLUSION" = "success" ]; then
              MSG="âœ… GitHub Pages ë°°í¬ ì™„ë£Œ\në¸Œëœì¹˜: $BRANCH\nì»¤ë°‹: $SHORT_SHA\nìƒì„¸: $RUN_URL"
            else
              MSG="âŒ GitHub Pages ë°°í¬ ì‹¤íŒ¨ ($CONCLUSION)\në¸Œëœì¹˜: $BRANCH\nì»¤ë°‹: $SHORT_SHA\nìƒì„¸: $RUN_URL"
            fi
          fi

          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            --data-urlencode text="$MSG"